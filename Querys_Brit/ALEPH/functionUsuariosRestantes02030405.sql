alter function sf_usuariosRestantesAleph (@clectivo varchar(4),@sesion varchar(1),@clase varchar(6))
returns table
as
return
(
SELECT 
DISTINCT PER.EMPLID collate Latin1_General_CI_AS AS COD_BAR,
DOC.NATIONAL_ID collate Latin1_General_CI_AS AS ID,
(NOM.LAST_NAME + ' ' + NOM.SECOND_LAST_NAME + ' ' + NOM.FIRST_NAME) collate Latin1_General_CI_AS AS NOMBRE,
PER.SEX collate Latin1_General_CI_AS AS GENERO,
CONVERT(CHAR(10),PER.BIRTHDATE,112) collate Latin1_General_CI_AS AS FNAC,
'' collate Latin1_General_CI_AS as LUGAR,
PH.PHONE collate Latin1_General_CI_AS AS TELEFONO,
PH.PHONE collate Latin1_General_CI_AS AS CELULAR, --lo mismo que telefono
(DIR.ADDRESS1 + ', ' + DIST.DESCR + ', ' + PROV.DESCR) collate Latin1_General_CI_AS AS DIRECCION,
EM.EMAIL_ADDR collate Latin1_General_CI_AS AS EMAIL
,  CONVERT(CHAR(10),DATEADD(YEAR,+1, B.SCC_ROW_UPD_DTTM),112)  collate Latin1_General_CI_AS AS F_FINAL
--, '' collate Latin1_General_CI_AS as ESTATUS --aqui va el case gigante
,( case  (SUBSTRING(A.ITEM_TYPE, 4, 10))
	when '701000002' then '02'--'CAT A' 
	when '701000003' then '01'--'CAT B'
	when '701000004' then '03'--'CAT C'
	when '701000005' then '05'--'CAT J'
	when '701000006' then '04'--'CAT U'
	else null	
	end
) collate Latin1_General_CI_AS AS ESTATUS
,'' collate Latin1_General_CI_AS as TIPO
,'ACP50,BBRIT,BBCAB' collate Latin1_General_CI_AS AS SUB_BIB
,'' collate Latin1_General_CI_AS AS NOTA_1
,'' collate Latin1_General_CI_AS AS NOTA_2      
,'' collate Latin1_General_CI_AS AS NOTA_3
,'' collate Latin1_General_CI_AS as LOCAL_LIB
,'' collate Latin1_General_CI_AS as PIP_LIB
,'' collate Latin1_General_CI_AS as PIB_TOTAL
,'' collate Latin1_General_CI_AS as PIB_ACTIVA
,'' collate Latin1_General_CI_AS as TIT_LIMITE
/*
,A.BUSINESS_UNIT,A.COMMON_ID,A.SA_ID_TYPE,A.ITEM_TYPE,A.ITEM_NBR,A.ITEM_AMT,A.APPLIED_AMT,A.ITEM_TERM
, (SELECT B.DESCR FROM PS_BRT_ITM_TYPE_VW B WHERE B.SETID='ACPBR' AND B.ITEM_TYPE=A.ITEM_TYPE)
--, (SELECT B.INVOICE_ID FROM PS_BI_BILLING_LINE B WHERE B.BUSINESS_UNIT=A.BUSINESS_UNIT AND B.COMMON_ID=A.COMMON_ID AND B.SA_ID_TYPE=A.SA_ID_TYPE AND B.ITEM_NBR=A.ITEM_NBR) FACTURA
, (SELECT C.BILL_DATE_TIME FROM PS_BI_BILL_HEADER C WHERE C.BUSINESS_UNIT=A.BUSINESS_UNIT AND C.INVOICE_ID= (SELECT B.INVOICE_ID FROM PS_BI_BILLING_LINE B WHERE B.BUSINESS_UNIT=A.BUSINESS_UNIT AND B.COMMON_ID=A.COMMON_ID AND B.SA_ID_TYPE=A.SA_ID_TYPE AND B.ITEM_NBR=A.ITEM_NBR) ) FECHA_FACTURA
*/
FROM PS_ITEM_SF A 
INNER JOIN PS_BRT_ITEMXREF_VW B ON B.BUSINESS_UNIT=A.BUSINESS_UNIT 
AND B.COMMON_ID=A.COMMON_ID 
AND B.SA_ID_TYPE=A.SA_ID_TYPE 
AND B.ITEM_NBR_CHARGE=A.ITEM_NBR
INNER JOIN PS_PERSONAL_DATA PER ON A.EMPLID=PER.EMPLID
LEFT OUTER JOIN PS_PERS_NID DOC
ON DOC.EMPLID = PER.EMPLID
LEFT OUTER JOIN PS_NAMES NOM
ON NOM.EMPLID = PER.EMPLID
LEFT OUTER JOIN PS_ADDRESSES DIR
ON DIR.EMPLID = PER.EMPLID
LEFT OUTER JOIN PS_MBO_PROVINC_TBL [PROV]
ON PROV.MBO_PROVINCIA = DIR.CITY AND PROV.STATE = DIR.STATE
LEFT OUTER JOIN PS_MBO_DISTRIT_TBL [DIST]
ON DIST.MBO_DISTRITO = DIR.COUNTY AND DIST.MBO_PROVINCIA = DIR.CITY AND DIST.STATE = DIR.STATE
LEFT OUTER JOIN PS_PERSONAL_PHONE PH
ON PH.EMPLID = PER.EMPLID
AND PH.PREF_PHONE_FLAG='Y'
LEFT OUTER JOIN PS_EMAIL_ADDRESSES EM
ON EM.EMPLID = PER.EMPLID
AND EM.PREF_EMAIL_FLAG='Y'
WHERE A.ITEM_TYPE IN ('010701000002'
,'010701000003'
,'010701000004'
,'010701000005'
,'010701000006'
,'020701000002'
,'020701000003'
,'020701000004'
,'020701000005'
,'020701000006'
,'030701000002'
,'030701000003'
,'030701000004'
,'030701000005'
,'030701000006'
,'040701000002'
,'040701000003'
,'040701000004'
,'040701000005'
,'040701000006'
,'050701000002'
,'050701000003'
,'050701000004'
,'050701000005'
,'050701000006'
,'060701000002'
,'060701000003'
,'060701000004'
,'060701000005'
,'060701000006'
,'070701000002'
,'070701000003'
,'070701000004'
,'070701000005'
,'070701000006'
,'080701000002'
,'080701000003'
,'080701000004'
,'080701000005'
,'080701000006'
,'090701000002'
,'090701000003'
,'090701000004'
,'090701000005'
,'090701000006'
,'100701000002'
,'100701000003'
,'100701000004'
,'100701000005'
,'100701000006'
,'110701000002'
,'110701000003'
,'110701000004'
,'110701000005'
,'110701000006')
AND A.ITEM_TYPE_CD='C'
AND A.ITEM_AMT >0
AND A.APPLIED_AMT >0
AND A.ITEM_AMT - A.APPLIED_AMT=0
AND DIR.LASTUPDDTTM = (
	select MAX(w.LASTUPDDTTM)
	from PS_ADDRESSES w
	where DIR.EMPLID=w.EMPLID

)

)

select w.*
from sf_usuariosRestantesAleph('2016','L',null) w
where w.F_FINAL =

(
	select MAX(x.F_FINAL)
	from sf_usuariosRestantesAleph('2016','L',null) x
	where x.COD_BAR=w.COD_BAR
)
AND w.COD_BAR in ('2005032711','2005071640','2007028327','2011000744','31337')	
GROUP BY COD_BAR
--HAVING COUNT(COD_BAR)>1
--OJO CON QUE PUEDEN HABER DUPLICADOS ALGUNOS MIEMBROS TB HAN SIDO ALUMNOS Y SI SE VUELVEN REINGRESANTES PODRIAN DUPLICAR DATA
